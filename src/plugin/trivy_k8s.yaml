name: trivy_cluster_scan
provider: trivy
variables: 
- name: k8s_namespace
  default: "kube-system"
  description: namespace of cluster
- name: k8s_kubeconfig
  default: "/tmp/k8s_kubeconfig.yaml"
  description: kubeconfig of cluster
command: "echo > /tmp/k8s_kubeconfig.yaml && echo {{k8s_kubeconfig}} | base64 --decode > /tmp/k8s_kubeconfig.yaml && trivy k8s -n {{k8s_namespace}} --report summary all --kubeconfig /tmp/k8s_kubeconfig.yaml --format json --timeout 15m"
output: 
  data: Findings
  identifier: Results[0].Misconfigurations[0].ID
  title: Results[0].Misconfigurations[0].Title
  severity: Results[0].Misconfigurations[0].Severity
  source: "trivy"
  status: Results[0].Misconfigurations[0].Status
  report: Results[0].MisconfSummary
dependency:
  name: trivy
  version: "0.48.3"
  script: "apt-get update -y && apt-get install -y wget && wget https://storage.googleapis.com/zerone-uploads/binaries/trivy-v0.48.3 -O /usr/local/bin/trivy && chmod +x /usr/local/bin/trivy"