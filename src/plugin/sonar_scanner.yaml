name: sonarqube-code-scanner
provider: sonar-scanner
variables: 
- name: repo_name
  default: "repo name"
  description: repo to  scan
- name: git_username
  default: "git_username"
  description: git username
- name: git_token
  default: "git_token"
  description: git token
- name: branch
  default: "branch"
  description: git branch
- name: sonar_host
  default: "sonar_host"
  description: sonar-scanner host server
- name: sonar_username
  default: "sonar_username"
  description: user detail of the host
- name: sonar_password
  default: "sonar_password"
  description: login pass of the host server
- name: projectkey
  default: "projectkey"
  description: projectkey code scan
- name: projectname
  default: "projectname"
  description: projectname of the repo
command: "source ~/.profile && git clone -b {{branch}} https://{{git_username}}:{{git_token}}@{{repo_name}} vuln-check && sonar-scanner -Dsonar.projectBaseDir=vuln-check -Dsonar.host.url={{sonar_host}} -Dsonar.login={{sonar_username}} -Dsonar.password={{sonar_password}} -Dsonar.projectKey={{projectkey}} -Dsonar.projectName={{projectname}} && sleep 30 && curl -u {{user}}:{{pass}} -X GET {{host}}/api/issues/search?componentKeys={{projectkey}}&ps=100&s=FILE_LINE&additionalFields=_all&statuses=OPEN,REOPENED,CLOSED && rm -rf /vuln-check"
dependency:
  name: sonar-scanner
  version: "0.48.3"
  script: "apt update -y && apt install -y git curl wget unzip && rm -rf /tmp/* && rm -rf /usr/local/bin/sonar-scanner/* && mkdir -p /usr/local/bin/sonar-scanner && wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip -O /tmp/sonar-scanner.zip && unzip -q -d /tmp/sonar-scanner_temp /tmp/sonar-scanner.zip && mv /tmp/sonar-scanner_temp/sonar-scanner-5.0.1.3006-linux/* /usr/local/bin/sonar-scanner && rm -rf /tmp/sonar-scanner_temp /tmp/sonar-scanner.zip && chmod +x /usr/local/bin/sonar-scanner/bin/sonar-scanner && echo 'export PATH=$PATH:/usr/local/bin/sonar-scanner/bin' >> ~/.profile && source ~/.profile"