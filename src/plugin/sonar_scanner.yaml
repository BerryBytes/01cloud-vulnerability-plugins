name: sonarqube_repo
provider: sonarqube
variables: 
- name: repo_name
  default: "repo name"
  description: repo to  scan
- name: host
  default: "host"
  description: sonar-scanner host server
- name: user
  default: "user login"
  description: user detail of the host
- name: pass
  default: "pass"
  description: login pass of the host server
- name: projectkey
  default: "projectkey"
  description: projectkey code scan
- name: projectname
  default: "projectname"
  description: projectname of the repo
command: "git clone {{repo_name}} vuln-check && /usr/local/bin/sonar-scanner/bin/sonar-scanner -Dsonar.projectBaseDir=vuln-check -Dsonar.host.url={{host}} -Dsonar.login={{user}} -Dsonar.password={{pass}} -Dsonar.projectKey={{projectkey}} -Dsonar.projectName={{projectname}} &&  curl -u {{user}}:{{pass}} -X GET {{host}}/api/issues/search?componentKeys={{projectkey}}&ps=100&s=FILE_LINE&additionalFields=_all&statuses=OPEN,REOPENED,CLOSED && rm -rf /vuln-check"
dependency:
  name: sonar-scanner
  version: "0.48.3"
  script: "apt update -y && apt install -y git curl wget unzip && wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip -O /tmp/sonar-scanner.zip && unzip -q -d /tmp/sonar-scanner_temp /tmp/sonar-scanner.zip && mv /tmp/sonar-scanner_temp/* /usr/local/bin/sonar-scanner && rm -rf /tmp/sonar-scanner_temp/ /tmp/sonar-scanner.zip && chmod +x /usr/local/bin/sonar-scanner/bin/sonar-scanner && echo 'export PATH=$PATH:/usr/local/bin/sonar-scanner/bin' >> ~/.profile && source ~/.profile"