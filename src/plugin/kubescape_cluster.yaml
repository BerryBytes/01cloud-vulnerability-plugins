name: kubescape_cluster_scan
provider: kubescape
variables:
  - name: k8s_kubeconfig
    default: "/tmp/k8s_kubeconfig.yaml"
    description: kubeconfig of cluster
command: 'echo "${k8s_kubeconfig}" | base64 --decode > /tmp/k8s_kubeconfig.yaml && kubescape scan --kubeconfig /tmp/k8s_kubeconfig.yaml framework nsa --format json --output results.json && jq '\''.controls | map({resourceID: .key, controlID: .value.controlID, controlName: .value.name, controlStatus: .value.status, statusInfo: .value.statusInfo.status, resourceIDs: .value.resourceIDs, passedResources: .value.ResourceCounters.passedResources, failedResources: .value.ResourceCounters.failedResources, skippedResources: .value.ResourceCounters.skippedResources, excludedResources: .value.ResourceCounters.excludedResources, ignoredResources: .value.subStatusCounters.ignoredResources, score: .value.score, complianceScore: .value.complianceScore, scoreFactor: .value.scoreFactor, categoryName: .value.category.name, categoryId: .value.category.id}) | { "result": . }'\'' results.json > 2.json && cat 2.json'
output:
  data: .
  identifier: resourceID
  title: controlName
  severity: Severity
  source: "kubescape"
  description: categoryName
  package: categoryId
  installed_version: resourceID
  fixed_version: statusInfo.status
  recommendation: statusInfo.subStatus
  team: "kubescape"
  icon: "https://raw.githubusercontent.com/cncf/artwork/master/projects/kubescape/stacked/color/kubescape-stacked-color.svg"
  blueprint: "k8s"
  status: Status
dependency:
  name: kubescape
  version: "0.48.3"
  script: "apt-get update -y && apt-get install -y wget jq && wget https://supreme-test.s3.amazonaws.com/security/kubescape -O /usr/local/bin/kubescape && chmod +x /usr/local/bin/kubescape"
